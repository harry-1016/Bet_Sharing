<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="View cricket and tennis bets">
    <meta name="theme-color" content="#0a0e1a">
    <link rel="manifest" href="./manifest.json">
    <title>Betting Tracker</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e1a;
            color: white;
            min-height: 100vh;
            padding: 1rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(123, 47, 247, 0.1) 100%);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .title {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #00d4ff 0%, #7b2ff7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            color: #8b92b0;
        }
        
        /* Notifications Section */
        .notifications-section {
            margin-bottom: 2rem;
        }
        
        .notification-card {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.15) 0%, rgba(59, 130, 246, 0.15) 100%);
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .notification-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .notification-icon {
            font-size: 1.5rem;
        }
        
        .notification-title {
            font-size: 1.125rem;
            font-weight: 700;
            flex: 1;
        }
        
        .notification-time {
            font-size: 0.75rem;
            color: #8b92b0;
        }
        
        .notification-message {
            color: #e5e7eb;
            line-height: 1.6;
            margin-left: 2.25rem;
        }
        
        .notification-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.625rem;
            font-weight: 700;
            text-transform: uppercase;
            background: rgba(147, 51, 234, 0.2);
            color: #a78bfa;
            margin-left: 2.25rem;
            margin-top: 0.5rem;
        }
        
        .bet-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .bet-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .bet-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .detail-label {
            color: #8b92b0;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .detail-value {
            font-size: 1.125rem;
            font-weight: 700;
            margin-top: 0.25rem;
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 0.5rem;
        }
        
        .badge-cricket {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .badge-tennis {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        .badge-pending {
            background: rgba(250, 204, 21, 0.2);
            color: #facc15;
        }
        
        .badge-won {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .badge-lost {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .badge-void {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #8b92b0;
        }
        
        .sync-status {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .sync-status.synced {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .sync-status.syncing {
            background: rgba(250, 204, 21, 0.2);
            color: #facc15;
        }
        
        .sync-status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .enable-notifications-btn {
            background: linear-gradient(135deg, #9333ea 0%, #3b82f6 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 1rem;
            transition: transform 0.2s;
        }
        
        .enable-notifications-btn:hover {
            transform: translateY(-2px);
        }
        
        .enable-notifications-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCkmo-yTbEd8LE6XtAPsJkmstLos7wlUew",
            authDomain: "bet-sharing.firebaseapp.com",
            projectId: "bet-sharing",
            storageBucket: "bet-sharing.firebasestorage.app",
            messagingSenderId: "21069245479",
            appId: "1:21069245479:web:a851ffb095ddb1b93a7202"
        };

        // Initialize Firebase
        let db = null;
        let messaging = null;
        let firebaseInitialized = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            
            // Initialize messaging if supported
            if (firebase.messaging.isSupported()) {
                messaging = firebase.messaging();
            }
            
            firebaseInitialized = true;
            console.log('âœ… Firebase initialized');
        } catch (error) {
            console.error('âŒ Firebase initialization failed:', error);
        }

        // State
        let bets = [];
        let notifications = [];
        let syncStatus = 'syncing';
        let notificationPermission = 'default';
        let isSubscribed = false;

        // Register Service Worker
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('./service-worker.js');
                    console.log('âœ… Service Worker registered:', registration);
                    return registration;
                } catch (error) {
                    console.error('âŒ Service Worker registration failed:', error);
                }
            }
        }

        // Request notification permission and subscribe
        async function enableNotifications() {
            if (!('Notification' in window)) {
                alert('This browser does not support notifications');
                return;
            }

            try {
                const permission = await Notification.requestPermission();
                notificationPermission = permission;
                
                if (permission === 'granted') {
                    console.log('âœ… Notification permission granted');
                    
                    // Subscribe to FCM if supported
                    if (messaging) {
                        try {
                            const token = await messaging.getToken({
                                vapidKey: 'YOUR_VAPID_KEY_HERE' // You'll need to generate this
                            });
                            
                            if (token) {
                                // Save token to Firestore
                                await db.collection('subscriptions').add({
                                    token: token,
                                    userId: 'public-user',
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                
                                isSubscribed = true;
                                console.log('âœ… Subscribed to notifications:', token);
                            }
                        } catch (error) {
                            console.log('â„¹ï¸ FCM not available, using local notifications only');
                        }
                    }
                } else {
                    alert('Notification permission denied. Please enable it in browser settings.');
                }
                
                render();
            } catch (error) {
                console.error('Error enabling notifications:', error);
                alert('Failed to enable notifications: ' + error.message);
            }
        }

        // Listen for foreground messages
        if (messaging) {
            messaging.onMessage((payload) => {
                console.log('Message received:', payload);
                
                // Show notification using service worker
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'SHOW_NOTIFICATION',
                        payload: payload
                    });
                }
            });
        }

        // Load notifications from Firebase
        function loadNotifications() {
            if (!firebaseInitialized || !db) return;

            db.collection('notifications')
                .orderBy('timestamp', 'desc')
                .limit(10)
                .onSnapshot((snapshot) => {
                    notifications = [];
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        notifications.push({
                            id: doc.id,
                            title: data.title,
                            message: data.message,
                            type: data.type || 'info',
                            timestamp: data.timestamp?.toDate() || new Date()
                        });
                    });
                    
                    render();
                }, (error) => {
                    console.error('Error loading notifications:', error);
                });
        }

        // Load bets from Firebase
        function loadBets() {
            if (!firebaseInitialized || !db) {
                syncStatus = 'error';
                render();
                return;
            }

            db.collection('bets')
                .orderBy('timestamp', 'desc')
                .onSnapshot((snapshot) => {
                    bets = [];
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const betDate = data.timestamp?.toDate() || new Date();
                        betDate.setHours(0, 0, 0, 0);
                        
                        // Only show today's bets
                        if (betDate.getTime() === today.getTime()) {
                            bets.push({
                                id: doc.id,
                                sport: data.sport,
                                match: data.match,
                                bet: data.bet,
                                stake: parseFloat(data.stake),
                                odds: parseFloat(data.odds),
                                potentialReturn: parseFloat(data.potentialReturn),
                                outcome: data.outcome || 'pending',
                                profit: parseFloat(data.profit || 0),
                                timestamp: data.timestamp?.toDate() || new Date()
                            });
                        }
                    });
                    
                    syncStatus = 'synced';
                    render();
                }, (error) => {
                    console.error('Error loading bets:', error);
                    syncStatus = 'error';
                    render();
                });
        }

        // Format time ago
        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            return Math.floor(seconds / 86400) + 'd ago';
        }

        // Get notification icon
        function getNotificationIcon(type) {
            const icons = {
                'info': 'ðŸ“¢',
                'bet': 'ðŸŽ¯',
                'win': 'ðŸŽ‰',
                'loss': 'ðŸ˜¢',
                'update': 'ðŸ”„',
                'warning': 'âš ï¸'
            };
            return icons[type] || 'ðŸ“¬';
        }

        // Render UI
        function render() {
            const root = document.getElementById('root');
            
            let statusBadge = '';
            if (syncStatus === 'synced') {
                statusBadge = '<div class="sync-status synced">ðŸŸ¢ Live</div>';
            } else if (syncStatus === 'syncing') {
                statusBadge = '<div class="sync-status syncing">ðŸŸ¡ Connecting...</div>';
            } else {
                statusBadge = '<div class="sync-status error">ðŸ”´ Connection Error</div>';
            }
            
            let content = `
                <div class="container">
                    <div class="header">
                        <h1 class="title">ðŸŽ¯ Today's Bets</h1>
                        <p class="subtitle">${new Date().toLocaleDateString('en-IN', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</p>
                    </div>
                    
                    ${statusBadge}
                    
                    ${notificationPermission !== 'granted' ? `
                        <button class="enable-notifications-btn" onclick="enableNotifications()">
                            ðŸ”” Enable Notifications
                        </button>
                    ` : ''}
            `;
            
            // Notifications Section
            if (notifications.length > 0) {
                content += `
                    <div class="notifications-section">
                        <h2 class="section-title">ðŸ“¬ Messages</h2>
                `;
                
                notifications.forEach(notif => {
                    content += `
                        <div class="notification-card">
                            <div class="notification-header">
                                <span class="notification-icon">${getNotificationIcon(notif.type)}</span>
                                <span class="notification-title">${notif.title}</span>
                                <span class="notification-time">${timeAgo(notif.timestamp)}</span>
                            </div>
                            <div class="notification-message">${notif.message}</div>
                            <span class="notification-badge">${notif.type}</span>
                        </div>
                    `;
                });
                
                content += '</div>';
            }
            
            // Bets Section
            content += '<h2 class="section-title">ðŸŽ² Active Bets</h2>';
            
            if (bets.length === 0) {
                content += `
                    <div class="empty-state">
                        <div style="font-size: 4rem;">ðŸ“­</div>
                        <h2 style="margin-top: 1rem;">No bets today</h2>
                        <p style="margin-top: 0.5rem;">Check back later for updates</p>
                    </div>
                `;
            } else {
                bets.forEach(bet => {
                    const sportBadge = bet.sport === 'Cricket' ? 'badge-cricket' : 'badge-tennis';
                    const outcomeBadge = `badge-${bet.outcome}`;
                    
                    content += `
                        <div class="bet-card">
                            <div>
                                <span class="badge ${sportBadge}">${bet.sport}</span>
                                <span class="badge ${outcomeBadge}">${bet.outcome}</span>
                            </div>
                            <div class="bet-title">${bet.match}</div>
                            <div style="color: #8b92b0; margin-bottom: 1rem;">${bet.bet}</div>
                            
                            <div class="bet-details">
                                <div>
                                    <div class="detail-label">Stake</div>
                                    <div class="detail-value">â‚¹${bet.stake.toLocaleString()}</div>
                                </div>
                                <div>
                                    <div class="detail-label">Odds</div>
                                    <div class="detail-value">${bet.odds}</div>
                                </div>
                                <div>
                                    <div class="detail-label">Potential Return</div>
                                    <div class="detail-value">â‚¹${bet.potentialReturn.toLocaleString()}</div>
                                </div>
                                ${bet.outcome !== 'pending' ? `
                                <div>
                                    <div class="detail-label">Profit/Loss</div>
                                    <div class="detail-value" style="color: ${bet.profit >= 0 ? '#22c55e' : '#ef4444'}">
                                        ${bet.profit >= 0 ? '+' : ''}â‚¹${bet.profit.toLocaleString()}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            content += '</div>';
            root.innerHTML = content;
        }

        // Initialize
        notificationPermission = Notification.permission || 'default';
        render();
        registerServiceWorker();
        
        if (firebaseInitialized) {
            loadBets();
            loadNotifications();
        }
    </script>
</body>
</html>
